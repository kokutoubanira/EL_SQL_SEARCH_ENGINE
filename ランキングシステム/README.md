# kpiを考慮したランキングシステム

1. 推薦枠経由で観測されるコンバージョン数や収益、コンテンツ市長時間などのKPIを最大化したい
2. 推薦枠経由だけでなく、プラットフォーム全体で観測されるコンバージョン数や収益、コンテンツ視聴時間などのKPIを最大化したい

というような発展的なケースを想定↓推薦システムの構築手順を考えます。
1つ目のケースについては、クリックよりもあとの段階でコンバージョンなどの追加的な情報が観測されている構造をモデル化する必要がある。２つ目は推薦枠経由だけでなく、プラットフォーム全体について定義されたＫＰＩについて望ましい結果を得たいケースです。ここで、プラットフォーム全体について定義差rたKPIとは、ある単一の推薦枠に限らず検索やメール配信などの総量のことを指します。

## 推薦枠経由で観測される目的変数を最大化する

推薦枠でクリックが発生した後に追加的な情報が観測される問題を想定し、ランキングシステムの学習手順を導きます。これによりクリックデータだけからでは難しい、期待売上や収益の最大化などEコマースプラットフォームの推薦でよくある設定を直接敵に扱うことを目指します。追加的な情報を上手く活用することで、ユーザー体験により直結するKPIを扱うことができる。

## データ観測構造をモデル化する

KPIを設定した後はデータの構造をモデル化する.
ここでは、 クリックに加えクリック発生後にコンバージョンなどの目的変数が追加的に観測される状況をモデル化します。
プラットフォームに存在するユーザとアイテムを u∈ [n] = {1,2,...,n}とi∈[m]={1,2,..,m} で表します。次に本章で扱う問題設定では推薦枠経由の流入なのかそうではないのかが鍵となるわけですから、あるユーザに対するアイテムiの推薦の様子を記述するための記号を用意してあげると便利です。ここでは、 K (u,i) ∈ {0, 1,2,..., L} という多値確率変数を導入することで、に対してżを推薦したポジションを表すことにします。 uに対してiをポジションk (1≤k≤L)で推薦した場合、 K(u, i)=kが記録されます。一方で、 uに対してぇが推薦されなかった状況は、 K (u,i) = 0として記述します。 なお、 L は推薦枠に提示できるアイテムの最大数です。またC(u,i,k) ∈ {0,1}という2値確率変数で、アイテムiがユーザuにポジションで提示されたときのクリック発生有無を表します。 ユーザがア
イテムiをポジションにでクリックしていた場合はC(u,i,k) =1が、そうでない場合は C (u,i,k) = 0 が記録されます。 最後に、クリック発生後に観測される目的変数を R(u, i) ∈ R で表します。例えば、 KPIを総コンバージョン数に設定した場合、 R(u,i) を用いてユーザuとアイテムiの間のコンバージョン発生有無を表します。 すなわち、ひとえの間にコンバージョンが発生していたらR(u,i) = 1、 そうでない場合は R(u, i) = 0 となります。KPIを総購入金額に設定した場合は、 R(u, i) をユーザuがアイテムiに対して支払った金額として定義すればKPIと目的変数を対応させることができます。

ログデータとして得られる情報に対応する変数を導入した後は、それらの重要な側面に記号を容易し、変数間に存在する関係式を問題せっていに対応するように仮定することで、データの観測構造をモデル化します。

## プラットフォーム全体で観測される目的変数を最大化する

多くの場合最終的に達成したいのは推薦枠経由のKPIではなくプラットフォーム全体について定義されるKPIの最大化です。ここでは、推薦経由だけではないプラットフォーム全体で観測される総コンバージョン数や総購入金額、層視聴時間などのKPIを扱う為の手順を導きます。

### KPI

プラットフォーム全体についてのKPIを扱う為には、推薦枠を経由せずに発生する目的変数の存在も考慮する必要があります。推薦枠を経由せずに発生する目的変数もKPIに経由することを念頭に置かなければなりません。

推薦枠経由のKPIを最大化する手順をそのまま適用しただけではプラットフォーム全体で定義されたKPIを改善できるとは限りません。

簡単な数値の例
- ある１人のユーザーのみが存在する
- ユーザに対して3つのアイテムを推薦するか否かを決める
- 推薦できるのは3つのアイテムのうち1つのみ
- プラットフォーム全体で発生する期待売上の最大化を目指す

推薦した時
アイテム1: 100
アイテム2: 50
アイテム3: 10
推薦しなかった時
アイテム1: 100
アイテム2: 45
アイテム3: 0
推薦による期待売上の増加量
アイテム1: 0
アイテム2: 5
アイテム3: 10


## KPIを設定する

まずは、KPIを設定する。コンバージョンや購入金額、視聴時間などの情報が使える場合は、それらの情報と対応するKPIを扱うことができます。追加的な情報が得られる場合は、より柔軟にKPIを設定したとしてもそれを直接的にかつ容易に扱うことができる


## 実装

- 推薦枠経由で観測される目的変数のみを考慮する場合
- 推薦枠外で発生する目的も考慮する場合

のそれぞれの学習手順を実装し、半人工データを用い挙動の検証を行います。


### PyTorchを用いた実装
evaluate.py: テストデータにおけるnDCG@10を計算するための関数を実装.
loss.py: IPS推定量に基づくリストワイズ損失関数を実装.
model.py: 多層パーセプトロンに基づくスコアリング関数を実装.
utils.py: 半人工データを生成するための関数を実装.
### 半人工データを用いた簡易実験
naive-vs-ips.ipynb: 推薦枠内で定義されるKPIを扱う状況においてナイーブ推定量とIPS推定量の性能差を検証.
objective-misspecification.ipynb: ランキングシステム構築のための方針の誤設定が性能に与える影響を検証.

##　まとめ

クリックに加えてKPIと直接関連のある目的変数がクリック発生後に観測される状況を扱いました。具体的には、推薦枠経由のKPIとプラットフォーム全体のKPIをそれぞれ観測可能なデータのみから最適化する手順を導出した。特に推薦枠経由のKPIを扱う場合とプラットフォーム全体で定義されるKPIを扱う場合で考え方を切り替える必要がある点には注意が必要です。
